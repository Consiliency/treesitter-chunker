name: Build Distributions

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=${{ github.event.inputs.version }}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
      shell: bash

    - name: Build wheel
      run: |
        python -m build --wheel --outdir dist/

    - name: Upload wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}-py${{ matrix.python-version }}
        path: dist/*.whl

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build

    - name: Build sdist
      run: python -m build --sdist --outdir dist/

    - name: Upload sdist artifact
      uses: actions/upload-artifact@v4
      with:
        name: sdist
        path: dist/*.tar.gz

  build-manylinux:
    name: Build manylinux wheels
    runs-on: ubuntu-latest
    container:
      image: quay.io/pypa/manylinux2014_x86_64
    
    strategy:
      matrix:
        python: ['cp310-cp310', 'cp311-cp311', 'cp312-cp312']
    
    steps:
    - uses: actions/checkout@v3

    - name: Build wheels
      run: |
        /opt/python/${{ matrix.python }}/bin/python -m pip install build wheel
        /opt/python/${{ matrix.python }}/bin/python -m build --wheel --outdir dist/

    - name: Audit wheels
      run: |
        for wheel in dist/*.whl; do
          auditwheel repair "$wheel" -w dist/
          rm "$wheel"
        done

    - name: Upload manylinux wheels
      uses: actions/upload-artifact@v4
      with:
        name: manylinux-wheels-${{ matrix.python }}
        path: dist/*.whl

  collect-artifacts:
    name: Collect all artifacts
    needs: [build-wheels, build-sdist, build-manylinux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist/

    - name: List all artifacts
      run: |
        find dist -type f -name "*.whl" -o -name "*.tar.gz" | sort

    - name: Create checksums
      run: |
        cd dist
        sha256sum **/*.whl **/*.tar.gz > checksums.txt
        cat checksums.txt

    - name: Upload final artifacts
      uses: actions/upload-artifact@v4
      with:
        name: distribution-artifacts
        path: |
          dist/**/*.whl
          dist/**/*.tar.gz
          dist/checksums.txt