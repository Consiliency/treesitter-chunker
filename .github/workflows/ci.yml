name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache grammars
        uses: actions/cache@v4
        with:
          path: |
            grammars/
            build/
          key: grammars-${{ runner.os }}-${{ hashFiles('scripts/fetch_grammars.py') }}
          restore-keys: |
            grammars-${{ runner.os }}-

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev,api,viz,templates,advanced]"
          uv pip install --system git+https://github.com/tree-sitter/py-tree-sitter.git
          uv pip install --system toml httpx  # Required by tests

      - name: Fetch grammars
        run: python scripts/fetch_grammars.py
        continue-on-error: true  # Don't fail CI if grammar fetch fails

      - name: Build grammars
        run: python scripts/build_lib.py
        continue-on-error: true  # Grammar build is optional for linting

      - name: Ruff
        run: |
          # Run ruff on production code and tests only (exclude archive, logs, etc.)
          # Using project's pyproject.toml configuration for consistency
          ruff check chunker/ cli/ tests/ --exclude archive --exclude logs --exclude site

      - name: Black
        run: black --check chunker/ cli/ tests/ scripts/

      # Note: isort check removed - ruff handles import sorting (I001)


      - name: Mypy
        run: |
          # Run mypy on production code only, excluding tests and scripts
          # Note: continue-on-error until existing type issues are resolved
          mypy chunker/ cli/ --ignore-missing-imports
        continue-on-error: true

      - name: Pytest
        run: |
          # Run quick core tests for CI (no coverage - faster)
          # Full test suite with coverage runs in separate Test Suite workflow
          # Tests with missing optional deps will be skipped via pytest.importorskip
          pytest -n auto \
            --timeout=30 \
            --ignore=tests/integration/ \
            -q  # Quiet output for faster CI
        timeout-minutes: 10
